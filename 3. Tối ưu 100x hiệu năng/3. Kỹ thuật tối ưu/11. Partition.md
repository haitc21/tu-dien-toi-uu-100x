[Video](https://wecommit.com.vn/courses/chuong-trinh-dao-tao-toi-uu-co-so-du-lieu-cao-cap/lesson/ky-thuat-nay-la-gi-chung-ta-can-chu-y-gi-khi-su-dung-ky-thuat-nay/)

# Partition

- Là làm việc với Block dữ liệu => Để tối ưu thì làm việc với càng ít Block càng nhanh.
- Dữ liệu khi được Insert vào bảng sẽ được thêm 1 cách lộn xộn, và chỉnh sửa càng làm lộn xộn dữ liệu.
- Ban đầu dữ liệu nhỏ thì dung lượng table nhỏ thì sẽ không sao. Nhưng càng ngày càng lớn thì Block cần quét càng nhiều => chậm, treo...
- Kỹ thuật Partition đơn gian là chia bảng ra nhiều phần theo chiều ngang (Index theo chiều dọc). Ban đầu cả table là 1 **Segment** nhưng sau khi Partition thì mỗi Partition là 1 Segment => rõ ràng số Block cần làm việc giảm đi.
- Partition là chia dữ liệu thành các phần lưu trữ vật lý khác nhau nhưng về logic (cấu trúc) như nhau => tất cả câu lệnh thao tác với bảng không thay đổi.
- Partition có thể áp dụng với table và index.

>Note: Vì Partition được lưu ở Segment riêng biệt nên nó cũng cần **Garther** để cập nhật trạng thái cho DB biết giống như table.
>
# Lợi ích

- hiệu năng tốt và ổn định vì đã chia dữ liệu ra nên không lo dữ liệu lớn đần theo thời gian. Không nhữn tốt cho query mà còn lợi khi Join các bảng có Partition với nhau.
- Quản trị: Nếu không Partition thì Backup, dọn dẹp (xóa, move) cực lâu. Nếu có Partition và kết hợp với chiến lược vòng đời dữ liệu thì quản trị sẽ dễ dàng hơn nhiều.

# Khi nào dùng Partition

- Dung lượng bảng > 2GB.
- Dữ liệu bảng có quy luật VD: Theo thời gian, khu vực...

# Partition Key: Tiêu chi đánh Partition

- Điều kiện tìm kiếm theo nghiệp vụ.
- Giống Leading Column của Index.
- **Cực kỳ quan trọng vị nếu chọn sai còn làm giảm rất nặng hiệu năng** vì thay vì quét full bảng cho nhanh thì lại đi quét tất cả Partition vẫn bằng đấy Block lại còn thêm chi phí đi nhảy vào từng Partition. Giống kiêu đi leo cầu thang thay vì mảnh đất 100m 1 tầng là full bảng thì đi 10 tầng 10m thì thêm công đi thêm 9 cái cầu thang.

# Các kỹ thuật Partition

## 1. Partition Cơ bản

### 1.1 Partition By Range (80% được sử dụng)

- thường dùng theo ngày tháng.
- Đa phần được sử dụng.

``` SQL
CREATE TABLE sale_tange (
saleman_id NUMBER(5),
saleman_name VARCHAR2(250),
sales_amount NUMBER(10),
sales_date DATE
)
PARTITION BY RANGE(sales_date) (
    PARTITION sales jan2000 VALUES LESS THAN (TO_DATE('02/01/2000','DD/MM/YYYY')),
    PARTITION sales feb2000 VALUES LESS THAN (TO_DATE('03/01/2000','DD/MM/YYYY')),
    PARTITION sales mar2000 VALUES LESS THAN (TO_DATE('04/01/2000','DD/MM/YYYY')),
    PARTITION sales apr2000 VALUES LESS THAN (TO_DATE('05/01/2000','DD/MM/YYYY'))
);
```

- Vấn đề là nếu sales_date là '07/12/20001' thì dữ liệu sẽ đi đâu? **Lỗi luôn** vậy thì phải Add Partition hoặc là Partition Max (dèault).
- Partition Max
  - Ưu điểm: Tránh lỗi.
  - Càng ngày cục này càng phình to. Thì lại thêm kỹ thuật **Split Partition**.

### 1.2 Partition By Hash

- **Chia đều** dữ liệu bảng ra thành các phần không phụ thuộc logic.
- Khác với Partition By Range là chia theo logic nhưng không đảm bảo đều vì các tháng có thể có số lượng bản ghi khác nhau.

``` SQL
CREATE TABLE sale_tange (
saleman_id NUMBER(5),
saleman_name VARCHAR2(250),
sales_amount NUMBER(10),
sales_date DATE
)
PARTITION BY HASH (saleman_id)
PARTITIONS 4;
```

- Hệ thống tự động băm saleman_id rồi chia ra 4 phần bằng nhau.

### 1.3 Partition By List

- Bài toán kinh điển chia theo chi nhánh: Hà Nội, thái Bình...

``` SQL
CREATE TABLE sale_tange (
saleman_id NUMBER(5),
saleman_name VARCHAR2(250),
saleman_sate VARCHAR2(250),
sales_amount NUMBER(10),
sales_date DATE
)
PARTITION BY LIST (saleman_sate) (
    PARTITION sales_west VALUES('Califonia', 'Haawaii') COMPRESS,
    PARTITION savles_east VALUES('New york', 'Verginia', 'Florida'),
    PARTITION savles_central VALUES('Texas', 'Ilinois')
);
```

## 2. Partition kết hợp (Composite Partition hoặc Sub Partition)

- Bài toán: Chia theo tháng mà dữ liệu vẫn lớn vậy có thể chia tiếp không?
- Ví dụ chia Range theo ngày giao dịch (Partition) rôi List theo chi nhánh (SubPartition). Cái này còn phụ thuộc lại DB có hỗ trợ không.
- thoải mái sáng tạo sao cho phù hợp với nghiệp vụ truy vấn.
- Sub Partition chỉ hiệu quả trong 3 trường hợp sau và hiệu quả giảm dần:
  - Điều kiện chứa cả Partition Key và Sub Partition Key: Cả này tháng và chi nhánh.
  - Điều kiện chỉ chứa Partition Key: Chỉ ngày tháng.
  - Điều kiện chỉ chứa Sub Partition Key: Chỉ chi nhánh.
- Không quan trọng thứ tự điều kiện: tháng = 10 and chi nhánh = Hà Nội không khác gì chi nhánh = Hà Nội and tháng = 10. DB chỉ quan tâm là có Partition hay không thôi.

# Kiểm tra Partition

``` SQL
SELECT * FROM user_segments
```

# Q&A

- Trước Partition theo Quý sau dữ liệu lớn quá thì theo tháng được không?
  - Có thể làm được.
  - Cần cân nhắc:
    - Thời gian Downtime: Phụ thuộc dung lượng bảng.
    - DB có hỗ trợ không?
- thứ tự điều kiện where có quan trọng không?
  - Không quan trọng: WHERE dataa = '02/01/2000' and branch = 'Hà Nội' hay nược lại như nhau hết.
- Xử lý Partition Max:
  - Thủ công: Đến đầu năm thì lại Split lại Partition.
  - Tự động thêm 1 Partition khi đến thười điểm. Nhược điểm là cái này tự sinh ra tên rất khó quản lý.
- Khi Split Partition Max có ảnh hưởng gì đến dữ liệu không?
  - Không vì lúc này Partition Max không có dữ liệu
  - Cần quan tâm là việc có làm hỏng Index không? (Unusable Index).
- Không phải cứ nén là chậm:
  - Nến có thể tốt cho IO.
  - Nhưng tệ về CPU.
